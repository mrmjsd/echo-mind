name: CI/CD - EchoMind

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  lint-and-test:
    name: Lint & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.backend.txt ]; then pip install -r requirements.backend.txt; fi

      - name: Install frontend dependencies
        run: |
          if [ -f requirements.frontend.txt ]; then pip install -r requirements.frontend.txt; fi

      - name: Run tests (placeholder)
        run: |
          echo "Add pytest/streamlit e2e tests here."

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4


      - name: Install cloudflared
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Add known hosts
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_KNOWN_HOST: ${{ secrets.SSH_KNOWN_HOST }}
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          if [ -n "$SSH_KNOWN_HOST" ]; then
            echo "$SSH_KNOWN_HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Deploy via Cloudflare Tunnel SSH
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          APP_DIR: ${{ secrets.APP_DIR }}
          CF_ACCESS_SERVICE_TOKEN_ID: ${{ secrets.CF_ACCESS_SERVICE_TOKEN_ID }}
          CF_ACCESS_SERVICE_TOKEN_SECRET: ${{ secrets.CF_ACCESS_SERVICE_TOKEN_SECRET }}
          ROOT_ENV_B64: ${{ secrets.ROOT_ENV_B64 }}
          UI_ENV_B64: ${{ secrets.UI_ENV_B64 }}
        run: |
          cloudflared access ssh \
            --hostname "$SSH_HOST" \
            --service-token-id "$CF_ACCESS_SERVICE_TOKEN_ID" \
            --service-token-secret "$CF_ACCESS_SERVICE_TOKEN_SECRET" \
            --url "ssh://localhost:$SSH_PORT" \
            -- \
            ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" << 'EOF'
              set -e
              echo "Connected through Cloudflare Tunnel"

              cd "$APP_DIR"

              if [ -n "$ROOT_ENV_B64" ]; then
                echo "Updating root .env"
                echo "$ROOT_ENV_B64" | base64 -d > .env
              fi

              if [ -n "$UI_ENV_B64" ]; then
                echo "Updating ui/.env"
                mkdir -p ui
                echo "$UI_ENV_B64" | base64 -d > ui/.env
              fi

              echo "Pulling latest code..."
              git fetch --all
              git reset --hard origin/main

              echo "Restarting Docker services..."
              docker-compose down
              docker-compose pull || true
              docker-compose build --pull
              docker-compose up -d

              echo "Deployment completed successfully!"
            EOF
